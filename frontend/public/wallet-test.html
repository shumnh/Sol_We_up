<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Wallet Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #333;
        }
        .success { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        button {
            background: linear-gradient(45deg, #8b5cf6, #ec4899);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .wallet-info {
            background: rgba(139, 92, 246, 0.1);
            border: 2px solid #8b5cf6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîó Phantom Wallet Connection Test</h1>
    
    <div id="detection-status"></div>
    <div id="connection-status"></div>
    <div id="wallet-info"></div>
    
    <button onclick="checkWalletStatus()">Check Wallet Status</button>
    <button onclick="connectWallet()" id="connectBtn">Connect Wallet</button>
    <button onclick="disconnectWallet()" id="disconnectBtn" disabled>Disconnect</button>
    <button onclick="testBackendAuth()" id="authBtn" disabled>Test Backend Auth</button>
    
    <h3>Debug Log:</h3>
    <pre id="log"></pre>

    <script>
        let connectedWallet = null;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
        }

        function checkWalletStatus() {
            log('Checking wallet status...');
            
            if (typeof window === 'undefined') {
                updateStatus('detection-status', '‚ùå Window object not available', 'error');
                return;
            }
            
            if (!window.solana) {
                updateStatus('detection-status', '‚ùå No Solana wallet detected. Please install Phantom wallet.', 'error');
                log('No window.solana object found');
                return;
            }
            
            if (window.solana.isPhantom) {
                updateStatus('detection-status', '‚úÖ Phantom wallet detected!', 'success');
                log('Phantom wallet detected successfully');
            } else {
                updateStatus('detection-status', '‚ö†Ô∏è Solana wallet found but not Phantom', 'warning');
                log('Solana wallet found but isPhantom is false');
            }
            
            if (window.solana.isConnected) {
                updateStatus('connection-status', 'üîó Wallet is already connected', 'success');
                if (window.solana.publicKey) {
                    const address = window.solana.publicKey.toString();
                    connectedWallet = address;
                    updateWalletInfo(address);
                    updateButtons(true);
                }
            } else {
                updateStatus('connection-status', 'üîå Wallet not connected', 'warning');
                updateButtons(false);
            }
        }

        function updateWalletInfo(address) {
            const walletInfo = document.getElementById('wallet-info');
            walletInfo.innerHTML = `
                <div class="wallet-info">
                    <strong>üîó Connected Wallet:</strong><br>
                    <code>${address}</code><br>
                    <small>First 8: ${address.slice(0, 8)}... Last 4: ...${address.slice(-4)}</small>
                </div>
            `;
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('authBtn').disabled = !connected;
        }

        async function connectWallet() {
            try {
                log('Attempting to connect wallet...');
                updateStatus('connection-status', 'üîÑ Connecting...', 'warning');
                
                if (!window.solana || !window.solana.isPhantom) {
                    throw new Error('Phantom wallet not found');
                }
                
                const response = await window.solana.connect();
                log('Connect response received');
                
                if (!response || !response.publicKey) {
                    throw new Error('Failed to get public key from response');
                }
                
                const address = response.publicKey.toString();
                connectedWallet = address;
                
                log(`Wallet connected successfully: ${address}`);
                updateStatus('connection-status', '‚úÖ Wallet connected successfully!', 'success');
                updateWalletInfo(address);
                updateButtons(true);
                
            } catch (error) {
                log(`Connection error: ${error.message}`);
                updateStatus('connection-status', `‚ùå Connection failed: ${error.message}`, 'error');
                updateButtons(false);
            }
        }

        async function disconnectWallet() {
            try {
                if (window.solana && window.solana.disconnect) {
                    await window.solana.disconnect();
                }
                connectedWallet = null;
                updateStatus('connection-status', 'üîå Wallet disconnected', 'warning');
                document.getElementById('wallet-info').innerHTML = '';
                updateButtons(false);
                log('Wallet disconnected successfully');
            } catch (error) {
                log(`Disconnect error: ${error.message}`);
            }
        }

        async function testBackendAuth() {
            if (!connectedWallet) {
                log('No wallet connected for auth test');
                return;
            }
            
            try {
                log('Testing backend authentication...');
                
                const response = await fetch('http://localhost:4000/api/auth/wallet-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: connectedWallet,
                        userType: 'user'
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Backend authentication successful!');
                    log(`Token received: ${data.token ? 'Yes' : 'No'}`);
                    log(`User data: ${JSON.stringify(data.user, null, 2)}`);
                } else {
                    log(`‚ùå Backend authentication failed: ${data.message}`);
                    if (data.message?.includes('not found')) {
                        log('‚ÑπÔ∏è This means you need to register this wallet first');
                    }
                }
                
            } catch (error) {
                log(`Backend auth error: ${error.message}`);
            }
        }

        // Auto-check wallet status on page load
        window.addEventListener('load', () => {
            log('Page loaded, checking wallet status...');
            checkWalletStatus();
        });

        // Listen for wallet events
        if (window.solana) {
            window.solana.on?.('connect', () => {
                log('Wallet connect event fired');
                checkWalletStatus();
            });
            
            window.solana.on?.('disconnect', () => {
                log('Wallet disconnect event fired');
                connectedWallet = null;
                updateStatus('connection-status', 'üîå Wallet disconnected', 'warning');
                document.getElementById('wallet-info').innerHTML = '';
                updateButtons(false);
            });
        }
    </script>
</body>
</html> 